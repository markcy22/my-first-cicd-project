name: CI/CD Pipeline with Environments

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
    
    - name: Verify HTML file exists
      run: |
        echo "Checking if index.html exists..."
        if [ -f "index.html" ]; then
          echo "‚úÖ index.html found!"
        else
          echo "‚ùå index.html not found!"
          exit 1
        fi
    
    - name: Validate HTML Structure
      run: |
        echo "Installing HTML validator..."
        sudo apt-get update
        sudo apt-get install -y tidy
        
        echo "Validating HTML..."
        tidy -q -e index.html || true
        
        echo "‚úÖ HTML validation complete!"
    
    - name: Check for broken internal links
      run: |
        echo "Checking for broken links in HTML..."
        
        # Check if any href or src attributes are empty
        if grep -E 'href=""' index.html; then
          echo "‚ùå Found empty href attributes!"
          exit 1
        fi
        
        if grep -E 'src=""' index.html; then
          echo "‚ùå Found empty src attributes!"
          exit 1
        fi
        
        echo "‚úÖ No broken internal links found!"
    
    - name: Check for accessibility basics
      run: |
        echo "Checking basic accessibility requirements..."
        
        # Check for alt attributes on images (if any)
        if grep -q '<img' index.html; then
          if grep '<img' index.html | grep -v 'alt='; then
            echo "‚ö†Ô∏è  Warning: Some images might be missing alt attributes"
          fi
        fi
        
        # Check for proper heading structure
        if ! grep -q '<h1' index.html; then
          echo "‚ö†Ô∏è  Warning: No h1 heading found"
        else
          echo "‚úÖ H1 heading found!"
        fi
        
        # Check for lang attribute
        if ! grep -q 'lang=' index.html; then
          echo "‚ö†Ô∏è  Warning: No lang attribute in html tag"
        else
          echo "‚úÖ Language attribute found!"
        fi
        
        echo "‚úÖ Basic accessibility checks complete!"
    
    - name: Test summary
      run: |
        echo "======================================"
        echo "üéâ All automated tests passed!"
        echo "======================================"
        echo "‚úÖ File existence check"
        echo "‚úÖ HTML validation"
        echo "‚úÖ Link integrity check"
        echo "‚úÖ Accessibility basics"
        echo "======================================"
  
  deploy-dev:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    
    steps:
    - name: Deploy to Development
      run: |
        echo "üöÄ Deploying to DEVELOPMENT environment..."
        echo "üìç Environment: DEV"
        echo "‚úÖ Development deployment complete!"
  
  deploy-production:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to Production
      run: |
        echo "üöÄ Deploying to PRODUCTION environment..."
        echo "üìç Environment: PRODUCTION"
        echo "‚úÖ Production deployment complete!"
